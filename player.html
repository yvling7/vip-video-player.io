<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VIP视频播放器</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            background: #000;
            overflow: hidden;
        }
        #dplayer {
            width: 100%;
            height: 100vh;
            background: #000;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="loading">加载中...</div>
    <div id="dplayer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <script>
        class VideoPlayer {
            constructor() {
                this.init();
            }

            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const apiUrl = urlParams.get('api');
                const videoUrl = urlParams.get('video');
                
                if (!apiUrl || !videoUrl) {
                    this.showError('参数错误');
                    return;
                }

                // 创建隐藏的iframe
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = apiUrl + videoUrl;
                document.body.appendChild(iframe);

                // 监听iframe加载完成
                iframe.onload = () => {
                    try {
                        // 从iframe中获取video元素
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const videoElement = iframeDoc.querySelector('video');
                        
                        if (videoElement && videoElement.src) {
                            // 获取到视频地址，创建DPlayer
                            this.createPlayer(videoElement.src);
                            // 移除iframe
                            iframe.remove();
                        } else {
                            throw new Error('未找到视频元素');
                        }
                    } catch (error) {
                        console.error('解析失败:', error);
                        this.showError('解析失败，请返回重试');
                        iframe.remove();
                    }
                };
            }

            createPlayer(url) {
                const dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    video: {
                        url: url,
                        type: 'auto',
                        customType: {
                            hls: (video, player) => {
                                const hls = new Hls({
                                    debug: false,
                                    maxBufferLength: 30 * 2 * 10,
                                    maxMaxBufferLength: 30 * 2 * 10,
                                });
                                hls.loadSource(video.src);
                                hls.attachMedia(video);
                                hls.on(Hls.Events.ERROR, (event, data) => {
                                    this.handleHlsError(hls, player, data);
                                });
                            }
                        }
                    },
                    subtitle: {
                        url: '',
                        type: 'webvtt',
                        fontSize: '5vh',
                        bottom: '10%',
                        color: '#fff'
                    },
                    autoplay: true,
                    theme: '#b7daff',
                    lang: 'zh-cn',
                    hotkey: true,
                    preload: 'auto',
                    volume: 1.0,
                    mutex: true,
                    screenshot: true,
                    airplay: true,
                    playbackSpeed: [0.5, 0.75, 1, 1.25, 1.5, 2, 3],
                    contextmenu: [
                        {
                            text: 'VIP视频解析播放器',
                            link: 'https://github.com/yvling7/vip-video-player.io'
                        }
                    ]
                });

                this.enhancePlayer(dp);
                this.hideLoading();
            }

            handleHlsError(hls, player, data) {
                if (!data.fatal) return;

                switch(data.type) {
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        if (data.details === "manifestLoadError") {
                            const errno = JSON.parse(data.networkDetails.response).errno;
                            if (errno === 31341) {
                                hls.loadSource(hls.url);
                                player.notice('正在重试加载视频...');
                            } else {
                                player.notice('视频加载失败，请刷新页面重试');
                            }
                        } else {
                            hls.startLoad();
                            player.notice('网络错误，正在重试...');
                        }
                        break;
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        hls.recoverMediaError();
                        player.notice('视频解码错误，正在恢复...');
                        break;
                    default:
                        hls.destroy();
                        player.notice('播放器遇到错误，请刷新页面');
                        break;
                }
            }

            enhancePlayer(player) {
                // 记忆播放进度
                const videoUrl = new URLSearchParams(window.location.search).get('video');
                const savedTime = localStorage.getItem('dplayer-time-' + videoUrl);
                if (savedTime) {
                    player.seek(parseFloat(savedTime));
                }

                player.on('timeupdate', () => {
                    localStorage.setItem('dplayer-time-' + videoUrl, player.video.currentTime);
                });

                // 错误处理
                player.on('error', () => {
                    player.notice('视频加载失败，正在重试...');
                    setTimeout(() => {
                        player.reload();
                    }, 1000);
                });

                // 加载完成
                player.on('loadeddata', () => {
                    this.hideLoading();
                });
            }

            showError(msg) {
                document.querySelector('.loading').textContent = msg;
            }

            hideLoading() {
                document.querySelector('.loading').style.display = 'none';
            }
        }

        // 初始化播放器
        new VideoPlayer();
    </script>
</body>
</html>
